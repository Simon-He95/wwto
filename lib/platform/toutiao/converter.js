const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),fse=require("fs-extra"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config"),logger=require("../../utils/logger");function convert(e={}){const r=e.source||"./src",t=e.target||"./toutiao",p=e.assets||config.getAssets(r);gulp.src(p).pipe(gulp.dest(t)),gulp.src(r+"/**/*.wxss").pipe(replace(/\.wxss(["'])/g,function(e,r){return r})).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,r){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,r){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(rename(function(e){e.extname=".ttss"})).pipe(gulp.dest(t)),gulp.src(r+"/**/*.wxml").pipe(replace("wx:","tt:")).pipe(replace("tt:for-items","tt:for")).pipe(replace(".wxml",".ttml")).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,r){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,r){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url=["']{{([^{}\s\?=]+)}}/gi,function(e,r){return e.replace(r,"("+r+"[0]=='/' && "+r+"[1]=='/') ? 'https:' + "+r+":"+r)})).pipe(replace(/url\({{([^{}\s\?=]+)}}/gi,function(e,r){return e.replace(r,"("+r+"[0]=='/' && "+r+"[1]=='/') ? 'https:' + "+r+":"+r)})).pipe(rename(function(e){e.extname=".ttml"})).pipe(gulp.dest(t));const i=t+"/project.config.json",n=[r+"/**/*.json"];fs.exists(i,e=>{e&&n.push("!"+r+"/project.config.json"),gulp.src(n).pipe(gulp.dest(t))}),gulp.src(__dirname+"/adaptor.js").pipe(gulp.dest(t)).on("end",()=>{logger.info("复制 adaptor.js")}),gulp.src(r+"/**/*.js").pipe(replace(/['"](\/\/\w+\.\w+)/g,function(e,r){return e.replace(r,["https:",r].join(""))})).pipe(replace(/\.option\.transition\.delay/g,".delay")).pipe(replace(/\.option\.transition\.duration/g,".duration")).pipe(replace(/\.option\.transition\.timingFunction/g,".duration")).pipe(through2.obj(function(e,r,t){let p=e.history[0].replace(e.base,"").split(sysPath.sep),i=["var wx = require('"+new Array(p.length).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")+"').default;",ab2str(e.contents)].join("\r\n");e.contents=str2ab(i),this.push(e),t()})).pipe(gulp.dest(t))}module.exports=convert;
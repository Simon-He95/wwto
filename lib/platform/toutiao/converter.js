const fs=require("fs"),gulp=require("gulp"),fse=require("fs-extra"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config");function convert(e={}){const p=e.source||"./src",t=e.target||"./toutiao",r=e.assets||config.getAssets(p);gulp.src(r).pipe(gulp.dest(t)),gulp.src(p+"/**/*.wxss").pipe(replace('.wxss"','"')).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(rename(function(e){e.extname=".ttss"})).pipe(gulp.dest(t)),gulp.src(p+"/**/*.wxml").pipe(replace("wx:","tt:")).pipe(replace("tt:for-items","tt:for")).pipe(replace(".wxml",".ttml")).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url=["']{{([^{}\s\?=]+)}}/gi,function(e,p){return e.replace(p,"("+p+"[0]=='/' && "+p+"[1]=='/') ? 'https:' + "+p+":"+p)})).pipe(replace(/url\({{([^{}\s\?=]+)}}/gi,function(e,p){return e.replace(p,"("+p+"[0]=='/' && "+p+"[1]=='/') ? 'https:' + "+p+":"+p)})).pipe(rename(function(e){e.extname=".ttml"})).pipe(gulp.dest(t)),gulp.src(p+"/**/*.json").pipe(gulp.dest(t));const i=fs.readFileSync(__dirname+"/patch.js","utf8");gulp.src(p+"/**/*.js").pipe(replace(/['"](\/\/\w+\.\w+)/g,function(e,p){return e.replace(p,["https:",p].join(""))})).pipe(replace(/([\s\S]*)/,i+"$1")).pipe(replace(/\.option\.transition\.delay/g,".delay")).pipe(replace(/\.option\.transition\.duration/g,".duration")).pipe(replace(/\.option\.transition\.timingFunction/g,".duration")).pipe(replace(/([\w]+)\.setData\([^)]+}\)/g,function(e,p){return/['"][\w]+\.[\w]+['"]/.test(e)?e.replace(e,[e,";",p,".setData("+p+".data);"].join("")):e})).pipe(gulp.dest(t))}module.exports=convert;
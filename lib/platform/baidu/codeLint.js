const fs=require("fs"),readline=require("readline"),gulp=require("gulp"),replace=require("gulp-replace"),through2=require("through2");function codeLint(r={}){const e=r.source||"./src";var n=[],i=!1,o={warningInfo:["bind*={{str}} str不能包含函数调用（如：bindtap='flag ? 'fn1' : 'fn2''）","wx:for={{arr}}  `arr`不能包含函数调用（如：`wx:for='{{flag ? arr1 : arr2}}'`）","在同一个标签上，`wx:for`和`wx:if`不能同时使用  可使用block包裹一层"],currentWaring:0};gulp.src(e+"/**/*.wxml").pipe(replace(/bind.*["'].*\?.*}}["']/gi,function(r,e){r.split(" ")[0].includes("?")&&(n.push(r),o.currentWaring=0,i=!0)})).pipe(replace(/wx:for.*\?.*}}["']/gi,function(r,e){n.push(r),o.currentWaring=1,i=!0})).pipe(replace(/<.+wx[:-]for.*\s*>/gi,function(r,e){(r.includes("wx:if")||r.includes("wx-if"))&&(n.push(r),o.currentWaring=2,i=!0)})).pipe(through2.obj(function(r,e,c){i&&lintContainer(r.path,n,o.warningInfo[o.currentWaring]),i=!1,n=[],c()}))}function lintContainer(r,e,n){var i="./demo"+r.split("/demo")[1];console.log("文件 "+i+" 存在 "+e.length+" 处异常语法需要修复，具体异常如下：");var o=fs.createReadStream(i),c=readline.createInterface({input:o}),t=1;c.on("line",r=>{e.forEach(e=>{r.includes(e)&&console.log("第 "+t+" 行有异常代码\n建议修改此段代码 "+e+"\n修复提示："+n+"\n")}),t++}),c.on("close",()=>{})}module.exports=codeLint;
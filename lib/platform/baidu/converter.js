const fs=require("fs"),gulp=require("gulp"),fse=require("fs-extra"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config");function convert(e={}){const p=e.source||"./src",r=e.target||"./baidu",i=e.assets||config.getAssets(p);gulp.src(i).pipe(gulp.dest(r)),gulp.src(p+"/**/*.wxss").pipe(replace('.wxss"','"')).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/[^,}\n]*image[,{]/gi,function(e,p){return e.replace(/image/g,".fix-image-cls")})).pipe(rename(function(e){e.extname=".css"})).pipe(gulp.dest(r)),gulp.src(p+"/**/*.wxml").pipe(replace("wx:","s-")).pipe(replace("s-for-items","s-for")).pipe(replace(".wxml",".swan")).pipe(replace("></input>","/>")).pipe(replace(/<[\w]+/gi,function(e,p){return e.replace(/[A-Z]/g,e=>["-",e.toLowerCase()].join(""))})).pipe(replace(/<\/[\w]+>/gi,function(e,p){return e.replace(/[A-Z]/g,e=>["-",e.toLowerCase()].join(""))})).pipe(replace(/{{[^}]+(<)[^=\s][^}]+}}/gi,function(e,p){return e.replace(p,[p," "].join(""))})).pipe(replace(/{{[^}\d\w]*(\.)[\d][^}]+}}/g,function(e,p){return e.replace(p,["0",p].join(""))})).pipe(replace(/scroll-into-view=["']{{([^}]+)}}["']/g,function(e,p){return e.replace("{{","").replace("}}","").replace(p,"{="+p+"=}")})).pipe(replace(/scroll-top=["']{{([^}]+)}}["']/g,function(e,p){return e.replace("{{","").replace("}}","").replace(p,"{="+p+"=}")})).pipe(replace(/scroll-left=["']{{([^}]+)}}["']/g,function(e,p){return e.replace("{{","").replace("}}","").replace(p,"{="+p+"=}")})).pipe(replace(/<template.*\s+data=["']({{[^}]+}})/g,function(e,p){return e.replace(p,"{"+p+"}")})).pipe(replace(/<image([^>]+)>/g,function(e,p){return e.match(/class=/)?e:e.replace(p,[' class="fix-image-cls" ',p].join(""))})).pipe(replace(/url\(['"](\/\/[^'"]+)['"]\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url\((\/\/[^'"]+)\)/gi,function(e,p){return e.replace(/\/\//g,e=>"https:"+e)})).pipe(replace(/url=["']{{([^{}\s\?=]+)}}/gi,function(e,p){return e.replace(p,"("+p+"[0]=='/' && "+p+"[1]=='/') ? 'https:' + "+p+":"+p)})).pipe(replace(/url\({{([^{}\s\?=]+)}}/gi,function(e,p){return e.replace(p,"("+p+"[0]=='/' && "+p+"[1]=='/') ? 'https:' + "+p+":"+p)})).pipe(rename(function(e){e.extname=".swan"})).pipe(gulp.dest(r)),gulp.src(p+"/**/*.json").pipe(replace(/usingComponents([^}]+)/g,function(e,p){return e.replace(/"([\w]+)":/gi,(e,p)=>e.replace(p,p.replace(/[A-Z]/g,e=>["-",e.toLowerCase()].join(""))))})).pipe(gulp.dest(r));const n=fs.readFileSync(__dirname+"/patch.js","utf8");return gulp.src(p+"/**/*.js").pipe(replace(/['"](\/\/\w+\.\w+)/g,function(e,p){return e.replace(p,["https:",p].join(""))})).pipe(replace(/\.option\.transition\.delay/g,".delay")).pipe(replace(/\.option\.transition\.duration/g,".duration")).pipe(replace(/\.option\.transition\.timingFunction/g,".duration")).pipe(replace(/([\s\S]*)/,n+"$1")).pipe(gulp.dest(r))}module.exports=convert;
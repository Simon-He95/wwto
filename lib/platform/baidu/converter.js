const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("mp-converter").baidu;function convert(e={}){const r=e.source||"./src",t=e.target||"./baidu",s=e.assets||config.getAssets(r);gulp.src(s).pipe(gulp.dest(t)),gulp.src(r+"/**/*.wxss").pipe(replace(/[\s\S]*/g,function(e){return converter.wxss(e)})).pipe(rename(function(e){e.extname=".css"})).pipe(gulp.dest(t)),gulp.src(r+"/**/*.wxml").pipe(replace(/[\s\S]*/g,function(e){return converter.wxml(e)})).pipe(rename(function(e){e.extname=".swan"})).pipe(gulp.dest(t));const p=t+"/project.config.json",n=[r+"/**/*.json"];return fs.exists(p,e=>{e&&n.push("!"+r+"/project.config.json"),gulp.src(n).pipe(replace(/[\s\S]*/g,function(e,r){return converter.json(e)})).pipe(gulp.dest(t))}),gulp.src(__dirname+"/adaptor.js").pipe(gulp.dest(t)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),gulp.src(r+"/**/*.js").pipe(replace(/[\s\S]*/g,function(e,r){return converter.script(e)})).pipe(through2.obj(function(e,r,t){let s=e.history[0].replace(e.base,"").split(sysPath.sep),p=["import wx from '"+new Array(s.length).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")+"';",ab2str(e.contents)].join("\r\n");e.contents=str2ab(p),this.push(e),t()})).pipe(gulp.dest(t))}module.exports=convert;
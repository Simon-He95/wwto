const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),rename=require("gulp-rename"),replace=require("gulp-replace"),md5Hex=require("md5-hex"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),DOMParser=require("xmldom").DOMParser,config=require("../../config"),logger=require("../../utils/logger"),converter=require("mp-converter").alibaba,scopeStyle=require("../../scope/scope-style"),scopeTemplate=require("../../scope/scope-template");function convert(e={}){const r=e.source||"./src",s=e.target||"./alibaba",t=e.assets||config.getAssets(r);gulp.src(t).pipe(gulp.dest(s)),gulp.src(r+"/**/*.wxss").pipe(replace(/[\s\S]*/g,function(e,r){return converter.wxss(e)})).pipe(through2.obj(function(e,r,s){let t=e.history[0].replace(e.base,"").replace(".wxss",""),p=e.history[0].replace(".wxss",".json");fs.exists(p,r=>{if(r){let r=fs.readFileSync(p);if(/"component":\s*true/.test(r)){let r="_"+md5Hex(t),p=ab2str(e.contents);scopeStyle(r,p).then(r=>{e.contents=str2ab(r),this.push(e),s()})}else this.push(e),s()}else this.push(e),s()})})).pipe(rename(function(e){e.extname=".acss"})).pipe(gulp.dest(s)),gulp.src(r+"/**/*.wxml").pipe(replace(/[\s\S]*/g,function(e){return converter.wxml(e)})).pipe(through2.obj(function(e,r,s){let t=e.history[0].replace(e.base,"").replace(".wxml",""),p=e.history[0].replace(".wxml",".json");fs.exists(p,r=>{if(r){let r=fs.readFileSync(p);if(/"component":\s*true/.test(r)){let r="_"+md5Hex(t),p=ab2str(e.contents),o=(new DOMParser).parseFromString(p);scopeTemplate(o,r);let n=o.toString().replace(/xmlns:a=""/g,"").replace(/&amp;/g,"&").replace(/&quot;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">");e.contents=str2ab(n),this.push(e),s()}else this.push(e),s()}else this.push(e),s()})})).pipe(rename(function(e){e.extname=".axml"})).pipe(gulp.dest(s));const p=s+"/project.config.json",o=[r+"/**/*.json"];fs.exists(p,e=>{e&&o.push("!"+r+"/project.config.json"),gulp.src(o).pipe(replace(/[\s\S]*/g,function(e){return converter.json(e)})).pipe(gulp.dest(s))}),gulp.src("node_modules/mp-adaptor/lib/alibaba.js").pipe(rename("adaptor.js")).pipe(gulp.dest(s)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),gulp.src(r+"/**/*.js").pipe(replace(/[\s\S]*/g,function(e){return converter.script(e)})).pipe(through2.obj(function(e,r,s){let t=e.history[0].replace(e.base,"").split(sysPath.sep),p=["import wx from '"+new Array(t.length).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")+"';",ab2str(e.contents)].join("\r\n");e.contents=str2ab(p),this.push(e),s()})).pipe(gulp.dest(s))}module.exports=convert;
const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),rename=require("gulp-rename"),replace=require("gulp-replace"),md5Hex=require("md5-hex"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),{DOMParser:DOMParser}=require("xmldom"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("mp-converter").alibaba,scopeStyle=require("../../scope/scope-style"),scopeTemplate=require("../../scope/scope-template");function convert(e={}){const p=e.source||"./src",r=e.target||"./alibaba",s=e.assets||config.getAssets(p);gulp.src(s).pipe(gulp.dest(r)),gulp.src(`${p}/**/*.wxss`).pipe(replace(/[\s\S]*/g,e=>converter.wxss(e))).pipe(through2.obj(function(e,p,r){const s=e.history[0].replace(e.base,"").replace(".wxss",""),u=e.history[0].replace(".wxss",".json");fs.exists(u,p=>{if(p){const p=fs.readFileSync(u);if(/"component":\s*true/.test(p)){const p=`_${md5Hex(s)}`,u=ab2str(e.contents);scopeStyle(p,u).then(p=>{e.contents=str2ab(p),this.push(e),r()})}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".acss"})).pipe(gulp.dest(r)),gulp.src(`${p}/**/*.wxml`).pipe(replace(/[\s\S]*/g,e=>converter.wxml(e))).pipe(through2.obj(function(e,p,r){const s=e.history[0].replace(e.base,"").replace(".wxml",""),u=e.history[0].replace(".wxml",".json");fs.exists(u,p=>{if(p){const p=fs.readFileSync(u);if(/"component":\s*true/.test(p)){const p=`_${md5Hex(s)}`,u=ab2str(e.contents),a=(new DOMParser).parseFromString(u);scopeTemplate(a,p);const t=a.toString().replace(/xmlns:a=""/g,"").replace(/&amp;/g,"&").replace(/&quot;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">");e.contents=str2ab(t),this.push(e),r()}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".axml"})).pipe(gulp.dest(r));const u=`${r}/project.config.json`,a=[`${p}/**/*.json`];fs.exists(u,e=>{e&&a.push(`!${p}/project.config.json`),gulp.src(a).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(gulp.dest(r))}),gulp.src("node_modules/mp-adaptor/lib/alibaba.js").pipe(rename("adaptor.js")).pipe(gulp.dest(r)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),gulp.src(`${p}/**/*.js`).pipe(replace(/[\s\S]*/g,e=>converter.script(e))).pipe(through2.obj(function(e,p,r){const s=e.history[0].replace(e.base,"").split(sysPath.sep),u=[`import wx from '${new Array(s.length).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")}';`,ab2str(e.contents)].join("\r\n");e.contents=str2ab(u),this.push(e),r()})).pipe(gulp.dest(r))}module.exports=convert;
const fs=require("fs"),gulp=require("gulp"),readLine=require("readline"),through2=require("through2"),ab2str=require("arraybuffer-to-string"),logger=require("../utils/logger");function lintLine(e,r){return r.map(r=>r(e)).filter(e=>e)}function lintFile(e,r){const t=ab2str(e.contents),{path:n}=e;let i=[];return r.forEach(e=>{i=i.concat(e(t,n))}),i.filter(e=>e)}function lint(e,r="./src//**/*.wxml",t,n){gulp.src(r).pipe(through2.obj(function(r,i,l){const o=fs.createReadStream(r.path),u=readLine.createInterface({input:o}),a=lintFile(r,t),{path:c}=r;let s=0;u.on("line",e=>{s++,lintLine(e,n).forEach(e=>{a.push({path:c,line:s,source:e.source,rule:e.rule})})}),u.on("close",()=>{0===a.length&&logger.success(`检测通过：${r.path}`),a.sort((e,r)=>e.line>r.line?1:-1),a.forEach(r=>{logger.lintWarning(e,r.path,r.line,r.source,r.rule)})}),l()}))}module.exports=lint;
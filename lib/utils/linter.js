const fs=require("fs"),gulp=require("gulp"),readLine=require("readline"),through2=require("through2"),ab2str=require("arraybuffer-to-string"),logger=require("../utils/logger");function lintLine(e,r){return r.map(r=>r(e)).filter(e=>e)}function lintFile(e,r){const t=ab2str(e.contents),{path:n}=e;let i=[];return r.forEach(e=>{i=i.concat(e(t,n))}),i.filter(e=>e)}function lint(e,r="./src//**/*.wxml",t,n){gulp.src(r).pipe(through2.obj(function(r,i,l){const u=fs.createReadStream(r.path),o=readLine.createInterface({input:u}),s=lintFile(r,t),{path:a}=r;let c=0;o.on("line",e=>{c++,lintLine(e,n).forEach(e=>{s.push({path:a,line:c,source:e.source,rule:e.rule})})}),o.on("close",()=>{0===s.length&&logger.success(`检测通过：${r.path}`),s.sort((e,r)=>e.line>r.line?1:-1),s.forEach(r=>{logger.lintWarning(e,r.path,r.line,r.source,r.rule)})}),this.push(r),l()}))}module.exports=lint;